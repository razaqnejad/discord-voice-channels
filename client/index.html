<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Chat</title>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Voice Chat</h1>
    
        <!-- Input Section -->
        <div class="input-container">
            <input type="text" id="channelId" placeholder="Enter Channel ID">
        </div>
    
        <!-- Buttons -->
        <div class="button-container">
            <button onclick="joinChannel()">Join Channel</button>
            <button onclick="leaveChannel()">Leave Channel</button>
            <button onclick="toggleMute()">Mute/Unmute</button>
        </div>
    
        <!-- Users -->
        <h3>Users in Channel</h3>
        <ul id="userList"></ul>
    </div>

    <script>
        const socket = io("https://discord-voice-channels.onrender.com", { transports: ["websocket"], upgrade: false });
    
        const peer = new Peer(undefined, {
            host: "https://discord-voice-channels.onrender.com",  // Change this to your Render backend
            port: 9000,
            path: "/peerjs",
            secure: true
        });
    
        let peers = {};
        let currentChannel = null;
        let localStream = null;
    
        async function getMicrophoneStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log("Microphone access granted.");
                return localStream;
            } catch (error) {
                console.error("Microphone access denied:", error);
                alert("Please allow microphone access to use voice chat.");
                return null;
            }
        }
    
        peer.on("open", (peerId) => {
            console.log(`PeerJS connected: ${peerId}`);
    
            document.getElementById("joinBtn").addEventListener("click", async () => {
                currentChannel = document.getElementById("channelId").value;
                if (!currentChannel) {
                    alert("Please enter a channel ID.");
                    return;
                }
    
                localStream = await getMicrophoneStream();
                if (!localStream) return;
    
                socket.emit("join-channel", { peerId, channelId: currentChannel });
            });
        });
    
        socket.on("update-users", ({ users }) => {
            console.log(`Updating users: ${users}`);
            document.getElementById("userList").innerHTML = "";
    
            users.forEach(userId => {
                if (!peers[userId] && userId !== peer.id) connectToPeer(userId);
                const li = document.createElement("li");
                li.textContent = userId;
                li.id = `user-${userId}`;
                document.getElementById("userList").appendChild(li);
            });
        });
    
        function connectToPeer(userId) {
            console.log(`Connecting to peer: ${userId}`);
            const call = peer.call(userId, localStream);
    
            call.on("stream", (userStream) => {
                console.log(`Received audio from ${userId}`);
                const audio = document.createElement("audio");
                audio.srcObject = userStream;
                audio.autoplay = true;
                document.body.appendChild(audio);
            });
    
            call.on("close", () => {
                console.log(`Call with ${userId} closed.`);
            });
    
            peers[userId] = call;
        }
    
        peer.on("call", (call) => {
            console.log(`Receiving call from ${call.peer}`);
            call.answer(localStream);
    
            call.on("stream", (userStream) => {
                console.log(`Received audio from ${call.peer}`);
                const audio = document.createElement("audio");
                audio.srcObject = userStream;
                audio.autoplay = true;
                document.body.appendChild(audio);
            });
        });
    </script>    
</body>
</html>