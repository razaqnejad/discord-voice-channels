<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Chat</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Voice Chat</h1>
    
        <!-- Input Section -->
        <div class="input-container">
            <input type="text" id="channelId" placeholder="Enter Channel ID">
        </div>
    
        <!-- Buttons -->
        <div class="button-container">
            <button onclick="joinChannel()">Join Channel</button>
            <button onclick="leaveChannel()">Leave Channel</button>
            <button onclick="toggleMute()">Mute/Unmute</button>
        </div>
    
        <!-- Users -->
        <h3>Users in Channel</h3>
        <ul id="userList"></ul>
    </div>

    <script>
        const socket = io("https://discordvoicechannels.onrender.com", { transports: ["websocket"] });
        const peer = new Peer(undefined, { debug: 3 });
        let peers = {};
        let currentChannel = null;
        let localStream = null;

        async function getMicrophoneStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log("Microphone access granted.");
                return localStream;
            } catch (error) {
                console.error("Microphone access denied:", error);
                alert("Please allow microphone access.");
                return null;
            }
        }

        peer.on("open", (peerId) => {
            console.log(`PeerJS connected: ${peerId}`);
        });

        async function joinChannel() {
            currentChannel = document.getElementById("channelId").value;
            if (!currentChannel) return alert("Enter a channel ID.");
            localStream = await getMicrophoneStream();
            if (!localStream) return;
            socket.emit("join-channel", { peerId: peer.id, channelId: currentChannel });
        }

        peer.on("call", (call) => {
            call.answer(localStream);
            call.on("stream", (userStream) => playAudioStream(userStream));
        });

        socket.on("user-connected", (peerId) => connectToPeer(peerId));
        socket.on("user-disconnected", (peerId) => {
            if (peers[peerId]) peers[peerId].close();
            delete peers[peerId];
            removeUserFromList(peerId);
        });

        function connectToPeer(userId) {
            const call = peer.call(userId, localStream);
            call.on("stream", (userStream) => playAudioStream(userStream));
            call.on("close", () => console.log(`Call with ${userId} closed.`));
            peers[userId] = call;
        }

        function playAudioStream(stream) {
            const audio = document.createElement("audio");
            audio.srcObject = stream;
            audio.autoplay = true;
            document.body.appendChild(audio);
        }

        function leaveChannel() {
            if (!currentChannel) return;
            socket.emit("leave-channel");
            Object.values(peers).forEach(peer => peer.close());
            peers = {};
            currentChannel = null;
            document.getElementById("userList").innerHTML = "";
        }

        function toggleMute() {
            if (!localStream) return;
            localStream.getAudioTracks().forEach(track => (track.enabled = !track.enabled));
            console.log(localStream.getAudioTracks()[0].enabled ? "Unmuted" : "Muted");
        }
    </script>
</body>
</html>